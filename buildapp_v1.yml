---
- name: Prepare build
  hosts: build
  become: yes

  tasks:
   - name: Ensure mvn package is present
     apt:
      name: maven
      state: present

   - name: Ensure git package is	present
     apt:
      name: git
      state: present

- name: Build
  hosts: build
  become: yes

  tasks:
   - name: Clone app from git
     git:
      repo: 'https://github.com/boxfuse/boxfuse-sample-java-war-hello'
      dest: /home/user/build/

   - name: Build app
     shell: mvn package chdir="/home/user/build/"

   - name: Copy app from build
     synchronize:
      src: /home/user/build/target/hello-1.0.war
      dest: /home/user/
      mode: pull
     delegate_to: 127.0.0.1

- name: Prod
  hosts: prod
  become: yes

  tasks:
   - name: Install OpenJDK
     apt:
      name: openjdk-11-jre-headless

   - name: download tomcat server packages
     get_url:
      url: https://mirrors.estointernet.in/apache/tomcat/tomcat-9/v9.0.55/bin/apache-tomcat-9.0.55.tar.gz
      dest: /usr/local

   - name: extract tomcat packages
     unarchive:
      src: /usr/local/apache-tomcat-9.0.55.tar.gz
      dest: /usr/local
      remote_src: yes

   - name: start tomcat services
     shell: nohup /usr/local/apache-tomcat-9.0.55/bin/startup.sh

   - name: Copy app to prod
     copy:
      src: /home/user/hello-1.0.war
      dest: /var/lib/tomcat9/webapps

